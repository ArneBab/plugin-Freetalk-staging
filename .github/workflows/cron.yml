name: CI cronjobs

# FIXME: Add these cronjobs:
# - Weekly CI run on branches next and master
# - Daily CI run on branch master IF branch next of fred changed.
# FIXME: GHA runs cronjobs on the default branch only. But we should run these both on branches next
# and master.

on:
  schedule:
    # ATTENTION: When changing these, you MUST also change the other occurrences in the file!
    - cron: 12 18 * * 1 # At 18:12 on Monday
    # FIXME: For debugging this runs every 5 minutes. Decrease a lot once finished!
    - cron: 0/5 * * * *

jobs:
  weekly-ci-workflow:
    name: Weekly CI test, on xor-freenet's repo only
    if: |
      github.event.schedule == '12 18 * * 1'
      && github.repository == 'xor-freenet/plugin-Freetalk'
    uses: ./.github/workflows/gradle.yml

  # FIXME: From here on replace "fred_next" with fred "fred" to shorten noisy syntax.
  determine-if-fred-changed:
    name: Determine if fred branch next has changed
    # FIXME: Remove testing code "-DO-NOT-USE" after testing
    # TODO: Once the tests are reasonably stable remove the "github.repository == ..." line so the
    # cronjob also runs on Freenet's GitHub repo and fred developers thus get an email if their
    # changes break Freetalk.
    # NOTICE: I think GHA currently disables cronjobs if a repo did not have changes for 60 days,
    # check if that is true. Then it may be necessary to move the cronjob to the fred repo because
    # the Freetalk repo on Freenet's GitHub is not that frequently updated.
    if: |
      github.event.schedule == '0/5 * * * *'
      && github.repository == 'xor-freenet/plugin-Freetalk-DO-NOT-USE'
    runs-on: ubuntu-latest
    
    steps:
    - name: Download fred branch next HEAD revision of previous run
      uses: actions/download-artifact@v3
      with:
        name: previous_fred_next_revision
    
    - name: Load and print previous and current fred branch next HEAD revision
      id: get-revs
      shell: bash
      run: |
        set -o errexit
        
        echo 'Previous HEAD of fred branch next:'
        if [ -f previous_fred_next_revision ] ; then
            cat previous_fred_next_revision
        else
           echo 'NONE' | tee previous_fred_next_revision
        fi
        
        echo 'Current HEAD of fred branch next:'
        git ls-remote 'https://github.com/freenet/fred.git' \
          | awk '/refs[/]heads[/]next/ {print $1}' \
          | tee current_fred_next_revision
        
        echo "::set-output name=previous_fred_next_revision::$(<previous_fred_next_revision)"
        echo "::set-output name=current_fred_next_revision::$(<current_fred_next_revision)"
        
        mv --force current_fred_next_revision previous_fred_next_revision
    
    # Store fred revision before running CI test so if it fails due to changes at fred we don't
    # re-run it every day and thus send emails about the failure every day.
    - name: Upload fred branch next HEAD revision for next cronjob execution
      uses: actions/upload-artifact@v3
      with:
        name: previous_fred_next_revision
        path: previous_fred_next_revision
        if-no-files-found: error
    
    outputs:
      previous_fred_next_revision: ${{steps.get-revs.outputs.previous_fred_next_revision}}
      current_fred_next_revision: ${{steps.get-revs.outputs.current_fred_next_revision}}
  
  run-ci-test-if-fred-changed:
    name: Daily CI test if fred changed, on xor-freenet's Freetalk repo only
    needs: determine-if-fred-changed
    if: |
      ${{needs.determine-if-fred-changed.outputs.current_fred_next_revision}}
      != ${{needs.determine-if-fred-changed.outputs.previous_fred_next_revision}}
    uses: ./.github/workflows/gradle.yml
